# Конфигурация под битрикс

nginx + php (7.4, 8.2, 8.3, 8.4) + mysql + node 23 версии
а так же redis|memcached - при самостоятельной публикации

## Шаги публикации docker-compose.yml

Шаги:

0. Выбор фреймворка - bitrix
1. Выбрать версию php
2. Выбрать версию mysql - 5.7 или 8.0
3. Устанавливать ли node.js - Y или N, если установите Y, то будет создан сервис с node js 23 версии
    1. Если будет устанавливаться node.js, то нужно указать корневую директорию для него, то есть директория содержащая файл package.json. Путь указывается относительно корня сайта - local/js/vite или пустое поле если package.json в корне сайта.
4. Устанавливать ли sphinx - Y или N, если установите Y, то будет создан сервис с shphinx версии 2.2.11

После этого в директории где выполнялась команда появиться docker-compose.yml файл с настроенными сервисами.

## Cron

По умолчанию cron включен и выполняется задание на запуск файла ```/var/www/bitrix/modules/main/tools/cron_events.php```

Если необходимо добавить задания, то сделайте публикацию докерфайлов и файлов конфигурации

```bash
docky publish
```

Запись заданий осуществляйте в:
- `_docker/app/cron/appuser.txt` - для пользователя сайта
- `_docker/app/cron/root.txt` - для root пользователя

выполните команду

```bash
docky build
```

## Почта

Для отправки почты настроен SMTP клиент  - ```msmtp```

Для завершения настройки вам необходимо добавить вашу почту (в поля user и from) и пароль в файл:

- `_docker/app/msmtprc`

По умолчанию в этом файле заготовка под почту яндекса, для других сервисов просто сделайте новый блок аккаунта на основе yandex и замените имя аккаунта в строке ```account default```, тогда ваш аккаунт будет по умолчанию использоваться при отправке почты.

Если почта не отправляется или в проверке системы написано что почта не работает, то проверьте логи ```msmtp``` в контейнере, которые находятся в файле ```/home/appuser/msmtp.log```. Вероятнее всего произошла ошибка авторизации или почтовый сервис отклюнил отправку из-за подозрений в спаме.

## Sphinx (поисковая система)

sphinx (версия 2.2.11) является сервисом в docker-compose.yml (добавляется при установке) и собирается на основе Dockerfile из _docker/sphinx/Dockerfile, где так же лежит и файл конфигурации sphinx.conf.

После запуска контейнеров можно подключаться к sphinx:

```
sphinx:9306 - протокол MySql
sphinx:9312 - стандартный протокой
```

## Создание новых сайтов

0. Выполните команду ```docky down``` или убедитесь что контейнеры остановлены
1. Для создания сайта выполните команду ``` docky create site ```
2. Введите доменное имя сайта
3. Проверьте что все создано (в директории вашего сайта должна была появиться директории с названием введенного вашего доменного имени)
4. Выполните команду ``` docky build ```

## Символические ссылки

При добавлении сайта автоматически добавляются символические ссылки на каталоги - bitrix, local, upload для введенного домена.

# доп.команды 

