#!/bin/bash

HOSTS_FILE="./hosts"
SYSTEM_DRIVE=""
HOST_FILE_WINDOWS_WSL=""
HOST_FILE_WINDOWS=""
IS_WSL=false
POWERSHELL_IS_AVAILABLE=false

if [ ! -f "$HOSTS_FILE" ]; then
  echo "Файл $HOSTS_FILE не найден!"
  exit 1
fi

if command -v powershell.exe &> /dev/null; then
  POWERSHELL_IS_AVAILABLE=true;
fi

if [ "$POWERSHELL_IS_AVAILABLE" = true ]; then
  SYSTEM_DRIVE=$(powershell.exe -NoProfile -Command "[System.Environment]::SystemDirectory.Substring(0,1)" | tr -d '\r');
  if [ -z "$SYSTEM_DRIVE" ]; then
    echo "Ошибка: не удалось определить системный диск Windows!"
    exit 1
  fi
  HOST_FILE_WINDOWS_WSL="/mnt/${SYSTEM_DRIVE,,}/Windows/System32/drivers/etc/hosts";
  HOST_FILE_WINDOWS="${SYSTEM_DRIVE}:\\Windows\\System32\\drivers\\etc\\hosts";
  if [ -f "$HOST_FILE_WINDOWS_WSL" ]; then
    IS_WSL=true;
  else
    echo "Файл hosts на Windows ($HOST_FILE_WINDOWS_WSL) не найден! Записи не будут добавлены в Windows."
    exit 1;
  fi
else 
  if [ ! -f "/etc/hosts" ]; then
    echo "/etc/hosts и powershell не найден!"
    exit 1
  fi
fi

mapfile -t HOSTS_LINES < "$HOSTS_FILE"

for HOST_ENTRY in "${HOSTS_LINES[@]}"; do
  if [ -z "$HOST_ENTRY" ]; then
    #echo "Пропускаем пустую строку..."
    continue
  fi

  echo "Добавление записи в hosts: $HOST_ENTRY"

  if [ "$IS_WSL" = true ]; then
    powershell.exe -ExecutionPolicy Bypass -NoProfile -File "$(dirname "$0")/hosts_push.ps1" -HOST_FILE_WINDOWS "$HOST_FILE_WINDOWS" -HOST_ENTRY "$HOST_ENTRY"
    if [ $? -eq 0 ]; then
      echo "Команда для строки выполнена успешно"
    else
      echo "Ошибка при добавлении записи в hosts на Windows через PowerShell."
    fi
  else
    if ! grep -q "$HOST_ENTRY" /etc/hosts; then
        echo "$HOST_ENTRY" | sudo tee -a /etc/hosts > /dev/null
        echo "Запись добавлена в /etc/hosts на Linux."
        STATUS=0
    else
        echo "Запись уже существует в /etc/hosts."
        STATUS=1
    fi
    
    if [ $STATUS -eq 0 ]; then
      echo "Команда для строки выполнена успешно"
    else
      echo "Ошибка при добавлении записи в /etc/hosts."
    fi
  fi
done
